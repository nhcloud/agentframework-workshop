using System.Net.Http.Json;
using System.Text.Json;
using Microsoft.Extensions.Logging;

namespace SampleMcpBridge;

/// <summary>
/// HTTP Client wrapper for calling the SampleRestApi.
/// This class handles all HTTP communication with the SampleRestApi running on port 5001.
/// </summary>
public class RestApiClient
{
    private readonly HttpClient _httpClient;
    private readonly ILogger<RestApiClient> _logger;
    private readonly JsonSerializerOptions _jsonOptions;

    public RestApiClient(IHttpClientFactory httpClientFactory, ILogger<RestApiClient> logger)
    {
        _httpClient = httpClientFactory.CreateClient("RestApi");
        _logger = logger;
        _jsonOptions = new JsonSerializerOptions 
        { 
            PropertyNameCaseInsensitive = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        };
    }

    /// <summary>
    /// Generic GET request to the REST API
    /// </summary>
    public async Task<T?> GetAsync<T>(string endpoint)
    {
        _logger.LogInformation("GET {Endpoint}", endpoint);
        
        try
        {
            var response = await _httpClient.GetAsync(endpoint);
            response.EnsureSuccessStatusCode();
            return await response.Content.ReadFromJsonAsync<T>(_jsonOptions);
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "HTTP error calling GET {Endpoint}", endpoint);
            throw;
        }
    }

    /// <summary>
    /// Generic GET request returning raw JSON string
    /// </summary>
    public async Task<string> GetAsStringAsync(string endpoint)
    {
        _logger.LogInformation("GET {Endpoint}", endpoint);
        
        try
        {
            var response = await _httpClient.GetAsync(endpoint);
            response.EnsureSuccessStatusCode();
            return await response.Content.ReadAsStringAsync();
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "HTTP error calling GET {Endpoint}", endpoint);
            throw;
        }
    }

    /// <summary>
    /// Generic POST request to the REST API
    /// </summary>
    public async Task<TResponse?> PostAsync<TRequest, TResponse>(string endpoint, TRequest data)
    {
        _logger.LogInformation("POST {Endpoint}", endpoint);
        
        try
        {
            var response = await _httpClient.PostAsJsonAsync(endpoint, data, _jsonOptions);
            response.EnsureSuccessStatusCode();
            return await response.Content.ReadFromJsonAsync<TResponse>(_jsonOptions);
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "HTTP error calling POST {Endpoint}", endpoint);
            throw;
        }
    }

    /// <summary>
    /// Generic PUT request to the REST API
    /// </summary>
    public async Task<TResponse?> PutAsync<TRequest, TResponse>(string endpoint, TRequest data)
    {
        _logger.LogInformation("PUT {Endpoint}", endpoint);
        
        try
        {
            var response = await _httpClient.PutAsJsonAsync(endpoint, data, _jsonOptions);
            response.EnsureSuccessStatusCode();
            return await response.Content.ReadFromJsonAsync<TResponse>(_jsonOptions);
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "HTTP error calling PUT {Endpoint}", endpoint);
            throw;
        }
    }

    // ???????????????????????????????????????????????????????????????????????????
    // HEALTH CHECK
    // ???????????????????????????????????????????????????????????????????????????

    public Task<string> GetHealthAsync() 
        => GetAsStringAsync("/api/health");

    // ???????????????????????????????????????????????????????????????????????????
    // WEATHER API - Note: SampleRestApi doesn't have weather endpoints
    // For weather, return simulated data or use a different source
    // ???????????????????????????????????????????????????????????????????????????

    public Task<string> GetWeatherAsync(string location)
    {
        // SampleRestApi doesn't have weather endpoints - return simulated data
        var weather = new
        {
            location,
            temperature = new Random().Next(5, 35),
            condition = new[] { "Sunny", "Cloudy", "Rainy", "Partly Cloudy" }[new Random().Next(4)],
            humidity = new Random().Next(40, 90),
            windSpeed = new Random().Next(5, 25),
            unit = "Celsius",
            source = "simulated",
            note = "Weather data is simulated - SampleRestApi focuses on business data"
        };
        return Task.FromResult(JsonSerializer.Serialize(weather, _jsonOptions));
    }

    public Task<string> GetWeatherLocationsAsync()
    {
        var locations = new
        {
            locations = new[] { "Seattle", "New York", "London", "Tokyo", "Paris", "Sydney", "Berlin", "Mumbai" },
            note = "Weather is simulated - these are example locations"
        };
        return Task.FromResult(JsonSerializer.Serialize(locations, _jsonOptions));
    }

    // ???????????????????????????????????????????????????????????????????????????
    // EMPLOYEE ENDPOINTS - SampleRestApi paths
    // ???????????????????????????????????????????????????????????????????????????

    public Task<string> GetAllEmployeesAsync() 
        => GetAsStringAsync("/api/employees");

    public Task<string> GetEmployeeAsync(int id) 
        => GetAsStringAsync($"/api/employees/{id}");

    public Task<string> SearchEmployeesAsync(string? name, string? department)
    {
        var query = new List<string>();
        if (!string.IsNullOrEmpty(name)) query.Add($"name={Uri.EscapeDataString(name)}");
        if (!string.IsNullOrEmpty(department)) query.Add($"department={Uri.EscapeDataString(department)}");
        
        var queryString = query.Count > 0 ? "?" + string.Join("&", query) : "";
        return GetAsStringAsync($"/api/employees/search{queryString}");
    }

    // ???????????????????????????????????????????????????????????????????????????
    // PRODUCT ENDPOINTS - SampleRestApi paths
    // ???????????????????????????????????????????????????????????????????????????

    public Task<string> GetAllProductsAsync() 
        => GetAsStringAsync("/api/products");

    public Task<string> GetProductAsync(int id) 
        => GetAsStringAsync($"/api/products/{id}");

    public Task<string> GetProductsByCategoryAsync(string category) 
        => GetAsStringAsync($"/api/products/category/{Uri.EscapeDataString(category)}");

    // ???????????????????????????????????????????????????????????????????????????
    // ORDER ENDPOINTS - SampleRestApi paths
    // ???????????????????????????????????????????????????????????????????????????

    public Task<string> GetAllOrdersAsync() 
        => GetAsStringAsync("/api/orders");

    public Task<string> GetOrderAsync(string id) 
        => GetAsStringAsync($"/api/orders/{Uri.EscapeDataString(id)}");

    public async Task<string> CreateOrderAsync(int customerId, List<int> productIds)
    {
        var request = new { customerId, productIds };
        var response = await _httpClient.PostAsJsonAsync("/api/orders", request, _jsonOptions);
        response.EnsureSuccessStatusCode();
        return await response.Content.ReadAsStringAsync();
    }

    public Task<string> GetCustomerOrdersAsync(string customerId) 
    {
        // SampleRestApi doesn't have a customer orders endpoint, 
        // so we get all orders and filter (or return empty)
        _logger.LogWarning("GetCustomerOrdersAsync: SampleRestApi doesn't have dedicated customer orders endpoint");
        return GetAsStringAsync("/api/orders");
    }

    // ???????????????????????????????????????????????????????????????????????????
    // INVENTORY ENDPOINTS - SampleRestApi paths
    // ???????????????????????????????????????????????????????????????????????????

    public Task<string> GetInventoryAsync() 
        => GetAsStringAsync("/api/inventory");

    public async Task<string> UpdateStockAsync(int productId, int newStock)
    {
        var request = new { newStock };
        var response = await _httpClient.PutAsJsonAsync($"/api/inventory/{productId}/stock", request, _jsonOptions);
        response.EnsureSuccessStatusCode();
        return await response.Content.ReadAsStringAsync();
    }
}
