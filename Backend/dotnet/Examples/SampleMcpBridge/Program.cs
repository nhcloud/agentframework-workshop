// ???????????????????????????????????????????????????????????????????????????????
// MCP BRIDGE SERVER
// ???????????????????????????????????????????????????????????????????????????????
// This MCP Server acts as a BRIDGE between MCP clients and your REST API.
// It translates MCP tool calls into HTTP requests to your existing REST endpoints.
//
// TRANSPORT MODES:
// 1. STDIO (default) - Spawned as subprocess by MCP client
// 2. SSE/HTTP - Runs as web server with SSE endpoint at /sse
//
// Set MCP_TRANSPORT=sse to run in HTTP/SSE mode
//
// NO CHANGES REQUIRED to your existing REST API!
// ???????????????????????????????????????????????????????????????????????????????

using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using ModelContextProtocol.Server;
using SampleMcpBridge;

// Build configuration
var configuration = new ConfigurationBuilder()
    .SetBasePath(Directory.GetCurrentDirectory())
    .AddJsonFile("appsettings.json", optional: true)
    .AddEnvironmentVariables()
    .Build();

// Get REST API URL from config or environment
var restApiBaseUrl = configuration["RestApi:BaseUrl"] 
    ?? Environment.GetEnvironmentVariable("REST_API_BASE_URL") 
    ?? "http://localhost:60095";

// Get transport mode from config or environment (stdio or sse)
var transportMode = configuration["McpServer:Transport"] 
    ?? Environment.GetEnvironmentVariable("MCP_TRANSPORT") 
    ?? "stdio";

// Get SSE port if using SSE transport
var ssePort = int.TryParse(
    configuration["McpServer:SsePort"] ?? Environment.GetEnvironmentVariable("MCP_SSE_PORT"), 
    out var port) ? port : 5050;

Console.Error.WriteLine("???????????????????????????????????????????????????????????");
Console.Error.WriteLine("  MCP BRIDGE SERVER - Connects MCP Clients to REST APIs");
Console.Error.WriteLine("???????????????????????????????????????????????????????????");
Console.Error.WriteLine($"  REST API URL: {restApiBaseUrl}");
Console.Error.WriteLine($"  Transport: {transportMode.ToUpper()}");
if (transportMode.Equals("sse", StringComparison.OrdinalIgnoreCase))
{
    Console.Error.WriteLine($"  SSE Endpoint: http://localhost:{ssePort}/sse");
}
Console.Error.WriteLine("???????????????????????????????????????????????????????????");

if (transportMode.Equals("sse", StringComparison.OrdinalIgnoreCase))
{
    // ???????????????????????????????????????????????????????????????????????????
    // SSE/HTTP MODE - Runs as web server with SSE endpoint
    // Connect via: http://localhost:{ssePort}/sse
    // ???????????????????????????????????????????????????????????????????????????
    var builder = WebApplication.CreateBuilder(args);
    
    builder.Services.AddSingleton<IConfiguration>(configuration);
    
    // Register HTTP client for calling the REST API
    builder.Services.AddHttpClient("RestApi", client =>
    {
        client.BaseAddress = new Uri(restApiBaseUrl);
        client.DefaultRequestHeaders.Add("Accept", "application/json");
        client.Timeout = TimeSpan.FromSeconds(30);
    });
    
    // Register the REST API client wrapper
    builder.Services.AddSingleton<RestApiClient>();
    
    // Configure logging
    builder.Logging.SetMinimumLevel(LogLevel.Information);
    
    // Register MCP Server with HTTP/SSE transport
    builder.Services.AddMcpServer()
        .WithHttpTransport()
        .WithToolsFromAssembly();
    
    var app = builder.Build();
    
    // Map the SSE endpoint
    app.MapMcp();
    
    Console.Error.WriteLine($"? MCP Bridge Server (SSE) starting on http://localhost:{ssePort}");
    Console.Error.WriteLine($"?? SSE Endpoint: http://localhost:{ssePort}/sse");
    Console.Error.WriteLine("?? Tools available: See RestApiTools.cs\n");
    
    app.Run($"http://localhost:{ssePort}");
}
else
{
    // ???????????????????????????????????????????????????????????????????????????
    // STDIO MODE - Spawned as subprocess (default)
    // Used when MCP client spawns this process
    // ???????????????????????????????????????????????????????????????????????????
    var builder = Host.CreateApplicationBuilder(args);
    
    builder.Services.AddSingleton<IConfiguration>(configuration);
    
    // Register HTTP client for calling the REST API
    builder.Services.AddHttpClient("RestApi", client =>
    {
        client.BaseAddress = new Uri(restApiBaseUrl);
        client.DefaultRequestHeaders.Add("Accept", "application/json");
        client.Timeout = TimeSpan.FromSeconds(30);
    });
    
    // Register the REST API client wrapper
    builder.Services.AddSingleton<RestApiClient>();
    
    // Configure logging to stderr (MCP uses stdout for protocol)
    builder.Logging.AddConsole(options => options.LogToStandardErrorThreshold = LogLevel.Trace);
    builder.Logging.SetMinimumLevel(LogLevel.Information);
    
    // Register MCP Server with STDIO transport
    builder.Services.AddMcpServer()
        .WithStdioServerTransport()
        .WithToolsFromAssembly();
    
    Console.Error.WriteLine("? MCP Bridge Server (STDIO) starting...");
    Console.Error.WriteLine("?? Tools available: See RestApiTools.cs");
    Console.Error.WriteLine("?? Listening on STDIO for MCP protocol messages...\n");
    
    var host = builder.Build();
    await host.RunAsync();
}
