// ???????????????????????????????????????????????????????????????????????????????
// SAMPLE REST API - Simulates your existing .NET 4.8 or .NET Core API
// ???????????????????????????????????????????????????????????????????????????????
// This represents YOUR existing REST API that you want to expose via MCP.
// It could be running on any .NET version (.NET 4.8, .NET Core, .NET 6/8/10, etc.)
// The MCP Server will call this API's endpoints and expose them as MCP tools.

var builder = WebApplication.CreateBuilder(args);

// Add services
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// In-memory data store (simulating a database)
builder.Services.AddSingleton<DataStore>();

var app = builder.Build();

// Configure Swagger
app.UseSwagger();
app.UseSwaggerUI();

// ???????????????????????????????????????????????????????????????????????????????
// REST API ENDPOINTS - These are your existing API endpoints
// ???????????????????????????????????????????????????????????????????????????????

// Health check
app.MapGet("/api/health", () => Results.Ok(new { status = "healthy", timestamp = DateTime.UtcNow }))
   .WithName("HealthCheck")
   .WithOpenApi();

// ???????????????????????????????????????????????????????????????????????????????
// EMPLOYEES API
// ???????????????????????????????????????????????????????????????????????????????

app.MapGet("/api/employees", (DataStore store) =>
{
    return Results.Ok(new { employees = store.Employees, total = store.Employees.Count });
})
.WithName("GetEmployees")
.WithOpenApi();

app.MapGet("/api/employees/{id}", (int id, DataStore store) =>
{
    var employee = store.Employees.FirstOrDefault(e => e.Id == id);
    return employee is null ? Results.NotFound(new { error = "Employee not found" }) : Results.Ok(employee);
})
.WithName("GetEmployee")
.WithOpenApi();

app.MapGet("/api/employees/search", (string? name, string? department, DataStore store) =>
{
    var results = store.Employees.AsEnumerable();
    
    if (!string.IsNullOrEmpty(name))
        results = results.Where(e => e.Name.Contains(name, StringComparison.OrdinalIgnoreCase));
    
    if (!string.IsNullOrEmpty(department))
        results = results.Where(e => e.Department.Equals(department, StringComparison.OrdinalIgnoreCase));
    
    return Results.Ok(new { employees = results.ToList(), total = results.Count() });
})
.WithName("SearchEmployees")
.WithOpenApi();

// ???????????????????????????????????????????????????????????????????????????????
// PRODUCTS API
// ???????????????????????????????????????????????????????????????????????????????

app.MapGet("/api/products", (DataStore store) =>
{
    return Results.Ok(new { products = store.Products, total = store.Products.Count });
})
.WithName("GetProducts")
.WithOpenApi();

app.MapGet("/api/products/{id}", (int id, DataStore store) =>
{
    var product = store.Products.FirstOrDefault(p => p.Id == id);
    return product is null ? Results.NotFound(new { error = "Product not found" }) : Results.Ok(product);
})
.WithName("GetProduct")
.WithOpenApi();

app.MapGet("/api/products/category/{category}", (string category, DataStore store) =>
{
    var products = store.Products.Where(p => p.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList();
    return Results.Ok(new { products, total = products.Count });
})
.WithName("GetProductsByCategory")
.WithOpenApi();

// ???????????????????????????????????????????????????????????????????????????????
// ORDERS API
// ???????????????????????????????????????????????????????????????????????????????

app.MapGet("/api/orders", (DataStore store) =>
{
    return Results.Ok(new { orders = store.Orders, total = store.Orders.Count });
})
.WithName("GetOrders")
.WithOpenApi();

app.MapGet("/api/orders/{id}", (string id, DataStore store) =>
{
    var order = store.Orders.FirstOrDefault(o => o.Id == id);
    return order is null ? Results.NotFound(new { error = "Order not found" }) : Results.Ok(order);
})
.WithName("GetOrder")
.WithOpenApi();

app.MapPost("/api/orders", (CreateOrderRequest request, DataStore store) =>
{
    var order = new Order
    {
        Id = $"ORD-{DateTime.UtcNow:yyyyMMdd}-{store.Orders.Count + 1:D4}",
        CustomerId = request.CustomerId,
        ProductIds = request.ProductIds,
        TotalAmount = request.ProductIds.Sum(pid => store.Products.FirstOrDefault(p => p.Id == pid)?.Price ?? 0),
        Status = "Pending",
        CreatedAt = DateTime.UtcNow
    };
    store.Orders.Add(order);
    return Results.Created($"/api/orders/{order.Id}", order);
})
.WithName("CreateOrder")
.WithOpenApi();

// ???????????????????????????????????????????????????????????????????????????????
// INVENTORY API
// ???????????????????????????????????????????????????????????????????????????????

app.MapGet("/api/inventory", (DataStore store) =>
{
    var inventory = store.Products.Select(p => new
    {
        p.Id,
        p.Name,
        p.Stock,
        Status = p.Stock > 10 ? "In Stock" : p.Stock > 0 ? "Low Stock" : "Out of Stock"
    });
    return Results.Ok(new { inventory, total = inventory.Count() });
})
.WithName("GetInventory")
.WithOpenApi();

app.MapPut("/api/inventory/{productId}/stock", (int productId, UpdateStockRequest request, DataStore store) =>
{
    var product = store.Products.FirstOrDefault(p => p.Id == productId);
    if (product is null) return Results.NotFound(new { error = "Product not found" });
    
    product.Stock = request.NewStock;
    return Results.Ok(new { message = "Stock updated", product });
})
.WithName("UpdateStock")
.WithOpenApi();

// Run using the configured URLs from launchSettings.json
// When running via 'dotnet run', use: dotnet run --urls "http://localhost:5001"
// Or set environment variable: ASPNETCORE_URLS=http://localhost:5001
app.Run();

// ???????????????????????????????????????????????????????????????????????????????
// DATA MODELS
// ???????????????????????????????????????????????????????????????????????????????

public class Employee
{
    public int Id { get; set; }
    public string Name { get; set; } = "";
    public string Email { get; set; } = "";
    public string Department { get; set; } = "";
    public string Title { get; set; } = "";
    public DateTime HireDate { get; set; }
}

public class Product
{
    public int Id { get; set; }
    public string Name { get; set; } = "";
    public string Description { get; set; } = "";
    public string Category { get; set; } = "";
    public decimal Price { get; set; }
    public int Stock { get; set; }
}

public class Order
{
    public string Id { get; set; } = "";
    public int CustomerId { get; set; }
    public List<int> ProductIds { get; set; } = new();
    public decimal TotalAmount { get; set; }
    public string Status { get; set; } = "";
    public DateTime CreatedAt { get; set; }
}

public class CreateOrderRequest
{
    public int CustomerId { get; set; }
    public List<int> ProductIds { get; set; } = new();
}

public class UpdateStockRequest
{
    public int NewStock { get; set; }
}

// ???????????????????????????????????????????????????????????????????????????????
// IN-MEMORY DATA STORE (Simulating a database)
// ???????????????????????????????????????????????????????????????????????????????

public class DataStore
{
    public List<Employee> Employees { get; } = new()
    {
        new() { Id = 1, Name = "Alice Johnson", Email = "alice@company.com", Department = "Engineering", Title = "Senior Developer", HireDate = new DateTime(2020, 3, 15) },
        new() { Id = 2, Name = "Bob Smith", Email = "bob@company.com", Department = "Engineering", Title = "Tech Lead", HireDate = new DateTime(2019, 7, 1) },
        new() { Id = 3, Name = "Carol Williams", Email = "carol@company.com", Department = "Marketing", Title = "Marketing Manager", HireDate = new DateTime(2021, 1, 10) },
        new() { Id = 4, Name = "David Brown", Email = "david@company.com", Department = "Sales", Title = "Sales Representative", HireDate = new DateTime(2022, 6, 20) },
        new() { Id = 5, Name = "Eva Martinez", Email = "eva@company.com", Department = "HR", Title = "HR Director", HireDate = new DateTime(2018, 11, 5) }
    };

    public List<Product> Products { get; } = new()
    {
        new() { Id = 1, Name = "Laptop Pro", Description = "High-performance laptop", Category = "Electronics", Price = 1299.99m, Stock = 50 },
        new() { Id = 2, Name = "Wireless Mouse", Description = "Ergonomic wireless mouse", Category = "Electronics", Price = 49.99m, Stock = 200 },
        new() { Id = 3, Name = "Office Chair", Description = "Comfortable ergonomic chair", Category = "Furniture", Price = 399.99m, Stock = 30 },
        new() { Id = 4, Name = "Standing Desk", Description = "Adjustable standing desk", Category = "Furniture", Price = 599.99m, Stock = 15 },
        new() { Id = 5, Name = "Monitor 27\"", Description = "4K Ultra HD monitor", Category = "Electronics", Price = 449.99m, Stock = 75 }
    };

    public List<Order> Orders { get; } = new()
    {
        new() { Id = "ORD-20240101-0001", CustomerId = 1, ProductIds = new() { 1, 2 }, TotalAmount = 1349.98m, Status = "Delivered", CreatedAt = new DateTime(2024, 1, 15) },
        new() { Id = "ORD-20240102-0002", CustomerId = 2, ProductIds = new() { 3 }, TotalAmount = 399.99m, Status = "Shipped", CreatedAt = new DateTime(2024, 2, 20) },
        new() { Id = "ORD-20240103-0003", CustomerId = 3, ProductIds = new() { 4, 5 }, TotalAmount = 1049.98m, Status = "Processing", CreatedAt = new DateTime(2024, 3, 10) }
    };
}
