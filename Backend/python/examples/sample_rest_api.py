"""
Sample REST API - Python Equivalent

This represents YOUR existing REST API that you want to expose via MCP.
It could be running on any Python version with FastAPI, Flask, Django, etc.
The MCP Server will call this API's endpoints and expose them as MCP tools.

Run with: uvicorn sample_rest_api:app --port 5001
"""

import logging
from datetime import datetime
from typing import List, Optional
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ???????????????????????????????????????????????????????????????????????????
# DATA MODELS
# ???????????????????????????????????????????????????????????????????????????

class Employee(BaseModel):
    id: int
    name: str
    email: str
    department: str
    title: str
    hire_date: datetime

    class Config:
        json_encoders = {datetime: lambda v: v.isoformat()}


class Product(BaseModel):
    id: int
    name: str
    description: str
    category: str
    price: float
    stock: int


class Order(BaseModel):
    id: str
    customer_id: int
    product_ids: List[int]
    total_amount: float
    status: str
    created_at: datetime

    class Config:
        json_encoders = {datetime: lambda v: v.isoformat()}


class CreateOrderRequest(BaseModel):
    customer_id: int
    product_ids: List[int]


class UpdateStockRequest(BaseModel):
    new_stock: int


# ???????????????????????????????????????????????????????????????????????????
# IN-MEMORY DATA STORE (Simulating a database)
# ???????????????????????????????????????????????????????????????????????????

class DataStore:
    def __init__(self):
        self.employees: List[Employee] = [
            Employee(id=1, name="Alice Johnson", email="alice@company.com", department="Engineering", title="Senior Developer", hire_date=datetime(2020, 3, 15)),
            Employee(id=2, name="Bob Smith", email="bob@company.com", department="Engineering", title="Tech Lead", hire_date=datetime(2019, 7, 1)),
            Employee(id=3, name="Carol Williams", email="carol@company.com", department="Marketing", title="Marketing Manager", hire_date=datetime(2021, 1, 10)),
            Employee(id=4, name="David Brown", email="david@company.com", department="Sales", title="Sales Representative", hire_date=datetime(2022, 6, 20)),
            Employee(id=5, name="Eva Martinez", email="eva@company.com", department="HR", title="HR Director", hire_date=datetime(2018, 11, 5)),
        ]
        
        self.products: List[Product] = [
            Product(id=1, name="Laptop Pro", description="High-performance laptop", category="Electronics", price=1299.99, stock=50),
            Product(id=2, name="Wireless Mouse", description="Ergonomic wireless mouse", category="Electronics", price=49.99, stock=200),
            Product(id=3, name="Office Chair", description="Comfortable ergonomic chair", category="Furniture", price=399.99, stock=30),
            Product(id=4, name="Standing Desk", description="Adjustable standing desk", category="Furniture", price=599.99, stock=15),
            Product(id=5, name="Monitor 27\"", description="4K Ultra HD monitor", category="Electronics", price=449.99, stock=75),
        ]
        
        self.orders: List[Order] = [
            Order(id="ORD-20240101-0001", customer_id=1, product_ids=[1, 2], total_amount=1349.98, status="Delivered", created_at=datetime(2024, 1, 15)),
            Order(id="ORD-20240102-0002", customer_id=2, product_ids=[3], total_amount=399.99, status="Shipped", created_at=datetime(2024, 2, 20)),
            Order(id="ORD-20240103-0003", customer_id=3, product_ids=[4, 5], total_amount=1049.98, status="Processing", created_at=datetime(2024, 3, 10)),
        ]


# Global data store instance
data_store = DataStore()


# ???????????????????????????????????????????????????????????????????????????
# FASTAPI APPLICATION
# ???????????????????????????????????????????????????????????????????????????

app = FastAPI(
    title="Sample REST API (Python)",
    description="Python equivalent of the .NET SampleRestApi - represents your existing business API",
    version="1.0.0",
    docs_url="/swagger",
    redoc_url="/redoc"
)

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# ???????????????????????????????????????????????????????????????????????????
# HEALTH CHECK
# ???????????????????????????????????????????????????????????????????????????

@app.get("/api/health")
async def health_check():
    """Health check endpoint."""
    return {"status": "healthy", "timestamp": datetime.utcnow().isoformat()}


# ???????????????????????????????????????????????????????????????????????????
# EMPLOYEES API
# ???????????????????????????????????????????????????????????????????????????

@app.get("/api/employees")
async def get_employees():
    """Get all employees."""
    return {
        "employees": [e.model_dump() for e in data_store.employees],
        "total": len(data_store.employees)
    }


@app.get("/api/employees/{employee_id}")
async def get_employee(employee_id: int):
    """Get employee by ID."""
    employee = next((e for e in data_store.employees if e.id == employee_id), None)
    if not employee:
        raise HTTPException(status_code=404, detail="Employee not found")
    return employee.model_dump()


@app.get("/api/employees/search")
async def search_employees(
    name: Optional[str] = Query(None),
    department: Optional[str] = Query(None)
):
    """Search employees by name and/or department."""
    results = data_store.employees
    
    if name:
        results = [e for e in results if name.lower() in e.name.lower()]
    
    if department:
        results = [e for e in results if e.department.lower() == department.lower()]
    
    return {
        "employees": [e.model_dump() for e in results],
        "total": len(results)
    }


# ???????????????????????????????????????????????????????????????????????????
# PRODUCTS API
# ???????????????????????????????????????????????????????????????????????????

@app.get("/api/products")
async def get_products():
    """Get all products."""
    return {
        "products": [p.model_dump() for p in data_store.products],
        "total": len(data_store.products)
    }


@app.get("/api/products/{product_id}")
async def get_product(product_id: int):
    """Get product by ID."""
    product = next((p for p in data_store.products if p.id == product_id), None)
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    return product.model_dump()


@app.get("/api/products/category/{category}")
async def get_products_by_category(category: str):
    """Get products by category."""
    products = [p for p in data_store.products if p.category.lower() == category.lower()]
    return {
        "products": [p.model_dump() for p in products],
        "total": len(products)
    }


# ???????????????????????????????????????????????????????????????????????????
# ORDERS API
# ???????????????????????????????????????????????????????????????????????????

@app.get("/api/orders")
async def get_orders():
    """Get all orders."""
    return {
        "orders": [o.model_dump() for o in data_store.orders],
        "total": len(data_store.orders)
    }


@app.get("/api/orders/{order_id}")
async def get_order(order_id: str):
    """Get order by ID."""
    order = next((o for o in data_store.orders if o.id == order_id), None)
    if not order:
        raise HTTPException(status_code=404, detail="Order not found")
    return order.model_dump()


@app.post("/api/orders", status_code=201)
async def create_order(request: CreateOrderRequest):
    """Create a new order."""
    # Calculate total amount
    total = sum(
        p.price for p in data_store.products 
        if p.id in request.product_ids
    )
    
    order = Order(
        id=f"ORD-{datetime.utcnow().strftime('%Y%m%d')}-{len(data_store.orders) + 1:04d}",
        customer_id=request.customer_id,
        product_ids=request.product_ids,
        total_amount=total,
        status="Pending",
        created_at=datetime.utcnow()
    )
    
    data_store.orders.append(order)
    return order.model_dump()


# ???????????????????????????????????????????????????????????????????????????
# INVENTORY API
# ???????????????????????????????????????????????????????????????????????????

@app.get("/api/inventory")
async def get_inventory():
    """Get inventory status for all products."""
    inventory = [
        {
            "id": p.id,
            "name": p.name,
            "stock": p.stock,
            "status": "In Stock" if p.stock > 10 else "Low Stock" if p.stock > 0 else "Out of Stock"
        }
        for p in data_store.products
    ]
    return {"inventory": inventory, "total": len(inventory)}


@app.put("/api/inventory/{product_id}/stock")
async def update_stock(product_id: int, request: UpdateStockRequest):
    """Update stock for a product."""
    product = next((p for p in data_store.products if p.id == product_id), None)
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    product.stock = request.new_stock
    return {"message": "Stock updated", "product": product.model_dump()}


# ???????????????????????????????????????????????????????????????????????????
# MAIN ENTRY POINT
# ???????????????????????????????????????????????????????????????????????????

if __name__ == "__main__":
    import uvicorn
    print("Starting Sample REST API (Python) on port 5001...")
    print("Swagger UI: http://localhost:5001/swagger")
    uvicorn.run(app, host="0.0.0.0", port=5001)
